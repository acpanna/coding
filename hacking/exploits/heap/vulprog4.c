#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <setjmp.h>

#define ERROR   -1
#define BUFSIZE 16

static char buf[BUFSIZE];
jmp_buf jmpbuf;

int i;
u_long getesp()
{
  __asm__("movl %esp,%eax"); /* the return value goes in %eax */
}

int main(int argc, char **argv)
{
  if (argc <= 1)
  {
    fprintf(stderr, "Usage: %s <string1> <string2>\n", argv[0]);
    exit(ERROR);
  }

  printf("[vulprog] argv[2] = %p\n", argv[2]);
  printf("[vulprog] sp = 0x%lx\n\n", getesp());

  if (setjmp(jmpbuf)) /* if > 0, we got here from longjmp() */
  {
    fprintf(stderr, "error: exploit didn't work\n");
    exit(ERROR);
  }

  printf("before:\n");
  printf("bx = 0x%lx, si = 0x%lx, di = 0x%lx\n", jmpbuf[JB_BX], jmpbuf[JB_SI], jmpbuf[JB_DI]);
  printf("bp = 0x%lx, sp = 0x%lx, pc = 0x%lx\n\n", jmpbuf[JB_BP], jmpbuf[JB_SP], jmpbuf[JB_PC]);
  
  /*
  for (i=0; i<6; i++)
    printf("jmpbuf[%d] - Adresse: 0x%lx - Inhalt: 0x%lx\n", i, &(jmpbuf[i]), jmpbuf[i]);
  */
  
  strncpy(buf, argv[1], strlen(argv[1])); /* actual copy here */

  printf("after:\n");
  printf("bx = 0x%lx, si = 0x%lx, di = 0x%lx\n", jmpbuf[JB_BX], jmpbuf[JB_SI], jmpbuf[JB_DI]);
  printf("bp = 0x%lx, sp = 0x%lx, pc = 0x%lx\n\n", jmpbuf[JB_BP], jmpbuf[JB_SP], jmpbuf[JB_PC]);

  longjmp(jmpbuf, 1);

  return 0;
}
